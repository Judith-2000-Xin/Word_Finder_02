<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Finder - Flex Final</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: "Times New Roman", serif;
      background: #f4f4f4;
    }

    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2vh 1vw;
    }

    .hidden { display: none; }

    .word-box {
      font-size: 1.4em;
      text-align: center;
      margin-bottom: 2vh;
    }

    .countdown {
      font-size: 1.2em;
      margin-bottom: 2vh;
      text-align: center;
    }

    .word-line {
      display: flex;
      justify-content: center;
      white-space: nowrap;
      overflow: hidden;
      margin: 0.3vh 0;
      letter-spacing: 0.1ch; /* ✅ 每字剛好有呼吸 */
    }

    .word-span {
      display: inline-block;
      width: 1ch;
      font-size: clamp(16px, 2.4vw, 26px); /* ✅ 字體隨裝置變化 */
      text-align: center;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
    }

    .word-span:hover {
      background: #dfe6e9;
    }

    .correct { background-color: #55efc4; }
    .wrong   { background-color: #fab1a0; }

    .timer-bar-container {
      width: 100%;
      max-width: 800px;
      height: 10px;
      background: #ddd;
      border-radius: 5px;
      overflow: hidden;
      margin-top: 2vh;
    }

    .timer-bar-fill {
      height: 100%;
      width: 100%;
      background: linear-gradient(to right, #74b9ff, #0984e3);
      transition: width 1s linear;
    }
  </style>
</head>
<body>
  <div id="prompt">
    <h2 style="text-align: center">Find these words:</h2>
    <div id="targetWords" class="word-box"></div>
    <div class="countdown">Starting in <span id="count">5</span>...</div>
  </div>

  <div id="rest" class="hidden">
    <div class="countdown">Take a 30-second break...<br>Next page in <span id="restCount">30</span> seconds</div>
  </div>

  <div id="game" class="hidden">
    <div id="gridContainer"></div>
    <div class="timer-bar-container">
      <div id="timerBar" class="timer-bar-fill"></div>
    </div>
  </div>

  <div id="result" class="hidden">
    <h2 style="text-align: center">✅ Game Completed</h2>
    <div id="summary"></div>
  </div>

  <script>
    const TOTAL_PAGES = 20;
    const LINES_PER_PAGE = 20;
    const LINE_LENGTH = 50;
    const PAGE_DURATION = 60;
    const WORD_POOL = ["COLOR", "COOL", "COAT", "MOON", "DATA", "CODE", "MAP", "RED", "BLUE", "SUN", "DOOR", "SKY", "TOP", "TASK", "TREE", "FIRE", "JUMP", "YES", "GO", "WIN"];

    let currentPage = 0;
    let times = [];
    let correctCounts = [];
    let targetWords = [];
    let foundWords = new Set();
    let pageTimeout;
    let timerInterval;
    let startTime;

    const promptEl = document.getElementById("prompt");
    const countEl = document.getElementById("count");
    const targetWordsEl = document.getElementById("targetWords");
    const gameEl = document.getElementById("game");
    const gridEl = document.getElementById("gridContainer");
    const resultEl = document.getElementById("result");
    const summaryEl = document.getElementById("summary");
    const restEl = document.getElementById("rest");
    const restCountEl = document.getElementById("restCount");
    const timerBar = document.getElementById("timerBar");

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function insertWordIntoLine(lineArr, word) {
      const maxPos = LINE_LENGTH - word.length;
      for (let i = 0; i < 50; i++) {
        const pos = Math.floor(Math.random() * maxPos);
        const canInsert = lineArr.slice(pos, pos + word.length).every(ch => !ch.dataset.word);
        if (canInsert) {
          for (let j = 0; j < word.length; j++) {
            lineArr[pos + j].textContent = word[j];
            lineArr[pos + j].dataset.word = word;
          }
          return true;
        }
      }
      return false;
    }

    function generatePage(words) {
      gridEl.innerHTML = "";
      const lines = [];

      for (let i = 0; i < LINES_PER_PAGE; i++) {
        const line = [];
        for (let j = 0; j < LINE_LENGTH; j++) {
          const span = document.createElement("span");
          span.className = "word-span";
          span.textContent = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"[Math.floor(Math.random() * 36)];
          line.push(span);
        }
        lines.push(line);
      }

      const usedLines = new Set();
      words.forEach(word => {
        let placed = false;
        while (!placed) {
          const lineIndex = Math.floor(Math.random() * LINES_PER_PAGE);
          if (!usedLines.has(lineIndex)) {
            placed = insertWordIntoLine(lines[lineIndex], word);
            if (placed) usedLines.add(lineIndex);
          }
        }
      });

      lines.forEach(line => {
        const div = document.createElement("div");
        div.className = "word-line";
        line.forEach(span => {
          span.onclick = () => handleClick(span);
          div.appendChild(span);
        });
        gridEl.appendChild(div);
      });

      startTimerBar(PAGE_DURATION);
      clearTimeout(pageTimeout);
      pageTimeout = setTimeout(() => {
        times.push(((Date.now() - startTime) / 1000).toFixed(2));
        correctCounts.push(`${foundWords.size}/${targetWords.length}`);
        currentPage++;
        stopTimerBar();
        if (currentPage === TOTAL_PAGES) showResult();
        else if (currentPage % 5 === 0) showRest();
        else nextPage();
      }, PAGE_DURATION * 1000);
    }

    function handleClick(span) {
      const word = span.dataset.word;
      if (span.classList.contains("correct")) {
        if (word) {
          foundWords.delete(word);
          document.querySelectorAll(`span[data-word='${word}']`).forEach(s => s.classList.remove("correct"));
        }
      } else if (word && !foundWords.has(word)) {
        foundWords.add(word);
        document.querySelectorAll(`span[data-word='${word}']`).forEach(s => s.classList.add("correct"));
      }

      if (foundWords.size === targetWords.length) {
        times.push(((Date.now() - startTime) / 1000).toFixed(2));
        correctCounts.push(`${foundWords.size}/${targetWords.length}`);
        currentPage++;
        clearTimeout(pageTimeout);
        stopTimerBar();
        setTimeout(() => {
          if (currentPage === TOTAL_PAGES) showResult();
          else if (currentPage % 5 === 0) showRest();
          else nextPage();
        }, 800);
      }
    }

    function startTimerBar(duration) {
      let remaining = duration;
      timerBar.style.width = "100%";
      timerInterval = setInterval(() => {
        remaining--;
        timerBar.style.width = (remaining / duration * 100) + "%";
        if (remaining <= 0) clearInterval(timerInterval);
      }, 1000);
    }

    function stopTimerBar() {
      clearInterval(timerInterval);
      timerBar.style.width = "0%";
    }

    function showRest() {
      promptEl.classList.add("hidden");
      gameEl.classList.add("hidden");
      restEl.classList.remove("hidden");
      let rest = 30;
      restCountEl.textContent = rest;
      const restTimer = setInterval(() => {
        rest--;
        restCountEl.textContent = rest;
        if (rest <= 0) {
          clearInterval(restTimer);
          restEl.classList.add("hidden");
          nextPage();
        }
      }, 1000);
    }

    function nextPage() {
      promptEl.classList.remove("hidden");
      gameEl.classList.add("hidden");
      foundWords = new Set();
      targetWords = shuffle([...WORD_POOL]).slice(0, Math.floor(Math.random() * 3) + 1);
      targetWordsEl.textContent = targetWords.join(", ");
      let countdown = 5;
      countEl.textContent = countdown;
      const interval = setInterval(() => {
        countdown--;
        countEl.textContent = countdown;
        if (countdown <= 0) {
          clearInterval(interval);
          promptEl.classList.add("hidden");
          gameEl.classList.remove("hidden");
          generatePage(targetWords);
          startTime = Date.now();
        }
      }, 1000);
    }

    function showResult() {
      gameEl.classList.add("hidden");
      resultEl.classList.remove("hidden");
      summaryEl.innerHTML = '<h3>Summary</h3>' + times.map((t, i) => {
        const [c, total] = correctCounts[i].split("/").map(Number);
        const accuracy = ((c / total) * 100).toFixed(1);
        return `Page ${i + 1}: ⏱ ${t}s – ✅ ${c}/${total} (${accuracy}%)`;
      }).join("<br>");
    }

    nextPage();
  </script>
</body>
</html>
